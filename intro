#!/bin/bash

# Intro CLI tool with gram-optic integration
# Handles the --spectre command for advanced workspace-based memory management

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

show_help() {
    cat << EOF
Intro CLI - Advanced System Management Tool

Usage: intro [OPTIONS]

Available options:
    --spectre           Activate Gram-Optic system (workspace-based memory management)
    --spectre-status    Show current status of Gram-Optic system
    --spectre-start     Start Gram-Optic system
    --spectre-stop      Stop Gram-Optic system  
    --spectre-restart   Restart Gram-Optic system
    --spectre-config    Configure Gram-Optic system
    -h, --help          Show this help message

Gram-Optic System:
    Implements a three-tier memory system:
    - Workspaces 1-3: Pure RAM (highest performance)
    - Workspaces 4-6: Disk swap with low compression (balanced)
    - Workspaces 7-9: ZRAM with medium compression (space-efficient)
EOF
}

# Function to activate spectre mode (gram-optic system)
activate_spectre() {
    echo "Initializing Gram-Optic system..."
    echo "Setting up three-tier memory management:"
    echo "- Workspaces 1-3: Pure RAM (Tier 1)"
    echo "- Workspaces 4-6: Disk swap with low compression (Tier 2)"
    echo "- Workspaces 7-9: ZRAM with medium compression (Tier 3)"
    
    # Make sure gram-optic script exists and is executable
    GRAM_OPTIC_SCRIPT="$SCRIPT_DIR/gram-optic.sh"
    if [ ! -f "$GRAM_OPTIC_SCRIPT" ]; then
        echo "Error: Gram-Optic system script not found at $GRAM_OPTIC_SCRIPT"
        exit 1
    fi
    
    chmod +x "$GRAM_OPTIC_SCRIPT"
    
    # Start the gram-optic system with default parameters
    "$GRAM_OPTIC_SCRIPT" start "$2"
    
    if [ $? -eq 0 ]; then
        echo "✓ Gram-Optic system (Spectre mode) activated successfully"
        echo "Workspace-based memory management is now active"
    else
        echo "✗ Failed to activate Gram-Optic system"
        exit 1
    fi
}

# Function to show spectre status
show_spectre_status() {
    GRAM_OPTIC_SCRIPT="$SCRIPT_DIR/gram-optic.sh"
    if [ -f "$GRAM_OPTIC_SCRIPT" ]; then
        "$GRAM_OPTIC_SCRIPT" status
    else
        echo "Gram-Optic system not found"
        exit 1
    fi
}

# Function to stop spectre
stop_spectre() {
    GRAM_OPTIC_SCRIPT="$SCRIPT_DIR/gram-optic.sh"
    if [ -f "$GRAM_OPTIC_SCRIPT" ]; then
        "$GRAM_OPTIC_SCRIPT" stop
        echo "✓ Gram-Optic system (Spectre mode) stopped"
    else
        echo "Gram-Optic system not found"
        exit 1
    fi
}

# Function to restart spectre
restart_spectre() {
    GRAM_OPTIC_SCRIPT="$SCRIPT_DIR/gram-optic.sh"
    if [ -f "$GRAM_OPTIC_SCRIPT" ]; then
        "$GRAM_OPTIC_SCRIPT" restart "$2"
        echo "✓ Gram-Optic system (Spectre mode) restarted"
    else
        echo "Gram-Optic system not found"
        exit 1
    fi
}

# Function to configure spectre
configure_spectre() {
    echo "Configuring Gram-Optic system..."
    echo "Current configuration:"
    
    # Show current configuration
    GRAM_OPTIC_SCRIPT="$SCRIPT_DIR/gram-optic.sh"
    if [ -f "$GRAM_OPTIC_SCRIPT" ]; then
        "$GRAM_OPTIC_SCRIPT" status
    fi
    
    # Configuration options
    echo ""
    echo "Configuration options:"
    echo "1. Change zram size for workspaces 7-9"
    echo "2. Change disk swap size for workspaces 4-6"
    echo "3. Show advanced configuration"
    read -p "Select option (1-3): " config_choice
    
    case $config_choice in
        1)
            read -p "Enter new zram size for workspaces 7-9 (e.g., 2G, 4G): " zram_size
            echo "To change zram size, restart the spectre system with the new size parameter:"
            echo "  intro --spectre-restart $zram_size"
            ;;
        2)
            read -p "Enter new disk swap size for workspaces 4-6 (e.g., 2G, 4G): " swap_size
            echo "To change disk swap size, restart the spectre system with the new size parameter:"
            echo "  intro --spectre-restart $swap_size"
            ;;
        3)
            echo "Advanced configuration requires editing the gram-optic script directly."
            echo "Configuration file location: $SCRIPT_DIR/gram-optic.sh"
            ;;
        *)
            echo "Invalid option selected."
            ;;
    esac
}

# Main command processing
case "$1" in
    --spectre)
        activate_spectre "$0" "$2"
        ;;
    --spectre-status)
        show_spectre_status
        ;;
    --spectre-start)
        activate_spectre "$0" "$2"
        ;;
    --spectre-stop)
        stop_spectre
        ;;
    --spectre-restart)
        restart_spectre "$0" "$2"
        ;;
    --spectre-config)
        configure_spectre
        ;;
    -h|--help)
        show_help
        ;;
    "")
        show_help
        ;;
    *)
        echo "Unknown option: $1"
        echo "Use --help for available options"
        exit 1
        ;;
esac